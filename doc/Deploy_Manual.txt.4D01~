Deploy Estuary into D01 board

Table of Contents:
Introduction
Preparation
    Prerequisite
    Check the hardware board
    Upgrade UEFI and trust firmware
Bring up System
    Boot via NORFLASH
    Boot via PXE
    Boot via SATA
        Preprocess when the disk can’t be identified
    Boot via ACPI
    Boot via NFS


### Introduction ###

This documentation describes how to get, build, deploy and bring up target system based Estuary Project, it will help you to make your Estuary Environment setup from ZERO.

All following sections will take the D01 board as example, other boards have the similar steps to do, for more detail difference between them, please refer to Hardware Boards sections in http://open-estuary.com/hardware-boards/.
 
### Preparation ###

# Prerequisite

    Local network: To connect hardware boards and host machine, so that they can communicate each other.
    
    Serial cable: To connect hardware board’s serial port to host machine, so that you can access the target board’s UART in host machine.

# Check the hardware board

    Hardware board should be ready and checked carefully to make sure it is available, more detail information about different hardware board, please refer to http://open-estuary.com/d01-2/.

# Upgrade UEFI and trust firmware

    You can upgrade UEFI and trust firmare yourself based on FTP service, but this is not necessary. If you really want to do it, please refer to UEFI_Manual.txt.

### Bring up System ###

There are several methods to bring up system, you can select following anyone fitting you to boot up.

# Boot via NORFLASH
    
    Boot D01 to UEFI SHELL, and type the follow commands in EBL:
    1. IP address config
    
    # Config board's IP address
    ifconfig -s eth0 <IP address> <mask> <gateway>
    e.g.: ifconfig -s eth0 192.168.1.4 255.255.255.0 192.168.1.1
    
    2. Download .kernel binary file from FTP
    
    # Download fiel from FTP server to target board's Flash
    provision <server IP> -u <ftp user name> -p <ftp password> -f <.kernel image file>
    # Write data into NORFLASH
    norwfmem <source address> <target address> <data length>
    e.g.: provision 192.168.1.107 -u sch -p aaa -f .kernel 
    
    3. Download rootfs file from FTP
    
    # Download fiel from FTP server to target board's Flash
    provision <server IP> -u <ftp user name> -p <ftp password> -f <rootfs image>
    e.g.: provision 192.168.1.107 -u sch -p aaa -f mini-rootfs.cpio.gz
    
    4. Reboot D01 and select "FLASH Start OS" boot option.
    
    To get all binaries mentioned above, please refer to Readme.txt.

# Show & change kernel command line in UEFI

    1. Boot D01 and enter EBL (UEFI shell).

    2. Use getlinuxatag to see current kernel parameter
        > getlinuxatag

    3. Use changelinuxatag to change kernel cmdline to this
        >  changelinuxatag
           ...
           console=ttyS0,115200 initrd=0x10d00000,0x1800000 rdinit=/linuxrc earlyprintk
           ...
    4. Use setlinuxatag to save comandline to FLASH
        > setlinuxatag

    5. Reboot board.

# Boot via PXE
    
    1. Setup PXE environment on host

    Enable both DHCP and TFTP services on one of your host machines according to Setup_PXE_Env_on_Host.txt.

    2. Reboot and press anykey to enter UEFI Boot Menu
    
    3. Select boot option "PXE on MAC Address: " with your board's MAC address as the end.
    
    4. After several seconds, D01 will boot by PXE automatically.
    
    To config the grub.cfg to support PXE boot, please refer to Grub_Manual.txt.

# Boot via SATA
    
    This part will tell you how to boot D01 via SATA disk with kernel image, dtb file, grub in it.
    In my case, my SATA disk will be partitioned into 3 parts: sda1(EFI part),sda2(Ubuntu rootfs),sda3(Fedora release).
    
    1. Boot by NORFLASH or PXE as description above.

    2. Part and format SATA disk

    Format SATA disk: mkfs -t ext4 /dev/sda
    Partition SATA disk as follow:
    
    +---------+-----------+--------------+------------------+
    | Name    |   Size    |    Type      |   Tag            |
    +---------+-----------+--------------+------------------+
    | sda1    |   200M    |  EFI system  |   EFI            |
    +---------+-----------+--------------+------------------+
    | sda2    |   10G     |    ext4      | linux filesystem |
    +---------+-----------+--------------+------------------+
    | sda3    |   10G     |    ext4      | linux filesystem |
    +---------+-----------+--------------+------------------+
    
    Note: EFI system should have a fat filesystem, so we must format sda1 with “mkfs.vfat /dev/sda1″.

    *** Preprocess when the disk can’t be identified ***
    
        When the disk is not identified by D01, you can try the following step to process the disk. (for some specfic disk eg seagate disk made by samsung, it can be useful)
        
        a. Find a PC or another board which can identify this disk
        You should find a PC or another board which can identify this disk, and the system of PC or board should be linux system. For us,we can use D01 board.
        
        b. Use tool fdisk to process this disk
        
        format the disk firstly: 
                            mkfs.ext4 /dev/sda
        add a gpt to this disk : 
                            fdisk /dev/sda
                            g-------add a gpt partition
        add some EFI partition : 
                            n-------add a partition
                            1-------the number of partition
                            +200M---------size of partition
                            t-------change the type of partition
                            EFI system
        add some anther partition  ...
        save the change           : w
        formate EFI partition  : mkfs.vfat /dev/sda1
        
        Then this disk can be identified by D01 board.
    
    3. Download files and store them into SATA as below.
        sda1: -------EFI
              |       |
              |       GRUB2------grubaa64.efi  //grub binary file
              |
              |-------------grub.cfg           //grub config file
              |
              |-------------Image_D01          //kernel binary Image
              |
              |-------------hip05-d02.dtb      //device tree binary
        sda2: Ubuntu distribution
        sda3: Fedora distribution

    How to get kernel image and dtb file, please refer to Readme.txt.
    How to get and config grub file to support SATA boot, please refer to Grub_Manual.txt.
    How to get different distributions, please refer to Distributions_Guider.txt.
    
    Note: The name of grub binary "grubaa64.efi" must be as same as the DHCP configure file in /etc/dhcp/dhcpd.conf.
    
    4. Reboot and press anykey to enter UEFI Boot Menu.

    5. Select boot from hardware disk

    6. Press arrow key up or down to select grub boot option to decide which distribution should boot.

# Boot via ACPI
    
    D01 also supports booting via ACPI, and the steps are as follows:

    1. Power on and enter UEFI SHELL

    2. IP address config
    
    ifconfig -s eth0 <IP address> <mask> <gateway>
    e.g.: ifconfig -s eth0 192.168.1.4 255.255.255.0 192.168.1.1
    
    3. Burn the kernel from FTP
    
    provision <server address> -u <ftp user name> -p <ftp password> -f <kernel image> -a <download target address>
    mdfile \<kernel image> <source address> <imagesize>
    e.g.: provision 192.168.1.107 -u d02 -p 123456 -f Image_D01 -a 0x80000
          mdfile \Image_D01 0x80000 0x82A000
    
    Note: imagesize must be the real Image size which can be gotten from previous command.
    
    4. Burn the filesystem from FTP
    
    provision <server address> -u <ftp user name> -p <ftp password> -f <rootfs image> -a <download target address>
    mdfile \<rootfs image> <source address> <imagesize>
    e.g.: provision 192.168.1.107 -u d02 -p 123456 -f mini-rootfs.cpio.gz -a 0x7000000
          mdfile \mini-rootfs.cpio.gz 0x7000000 0x1845F12
    
    Note: imagesize must be the real Image size which can be gotten from previous command
    
    5. Get into target directory to check whether the files downloaded above are there.
    
        cd fs0:
        dir
    
    6. Set the parameters of booting via ACPI
    
        start Image_D01 "acpi=fore console=ttyS0,115200 earlycon=uart8250,mmio32,0x80300000 initrd=mini-rootfs.cpio.gz"
    
# Boot via NFS
    
    D01 supports booting via NFS, you can try it as following steps:

    1. Enable DHCP, TFTP and NFS service according to Setup_PXE_Env_on_Host.txt.

    2. Change command line as description in above "Show & change kernel command line in UEFI"

        Change kernel cmdline to:

            console=ttyS0,115200 earlyprintk rootfstype=nfsroot root=/dev/nfs rw nfsroot=<NFS-server-ip>:<path-to-exported-NFS-files> ip=<client-ip>:<NFS-server-ip>:<gw-ip>:<netmask>::eth0:on:<dns0-ip>:<dns1-ip> user_debug=31 nfsrootdebug

                Here is an example:

                    console=ttyS0,115200 earlyprintk rootfstype=nfsroot root=/dev/nfs rw nfsroot=192.168.0.108:/Users/docularxu/Downloads/mnt ip=192.168.0.150:192.168.0.108:192.168.0.1:255.255.255.0::eth0:on:192.168.0.1:8.8.8.8 user_debug=31 nfsrootdebug

                        Note, this is an example. Please change the values according to your
                            local environment. Explanation of each parameter can be found in kernel
                                source Documentations. Like:

                                        ip=<client-ip>:<server-ip>:<gw-ip>:<netmask>:<hostname>:<device>:<autoconf>:<dns0-ip>:<dns1-ip>

                                            Reboot the board.
    2. Get and config grub file to support NFS boot according to Grub_Manual.txt.

    3. Reboot D01 and press anyke to enter UEFI Boot Menu

    4. Select boot option "PXE on MAC Address: " with your board's MAC address as the end.
